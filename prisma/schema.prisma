datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL") // Connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // Direct connection
}

generator client {
  provider = "prisma-client-js"
}

// Enums
enum EstadoActivo {
  DISPONIBLE
  ASIGNADO
  MANTENIMIENTO
  BAJA
}

enum TipoMantenimiento {
  PREVENTIVO
  CORRECTIVO
}

enum EstadoMantenimiento {
  PROGRAMADO
  EN_PROCESO
  COMPLETADO
  CANCELADO
}

// Enums para Tickets
enum TicketStatus {
  ABIERTO
  EN_PROGRESO
  ESPERA_CLIENTE
  RESUELTO
  CERRADO
}

enum TicketPriority {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

// Roles y Permisos Dinámicos
model Role {
  id          String       @id @default(cuid())
  name        String       @unique // "ADMIN", "USER", etc.
  description String?
  
  permissions Permission[]
  users       User[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique // "users:create", "assets:delete"
  description String?
  
  roles       Role[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Usuario del sistema (Administradores/Operadores)
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?   // Opcional si usas solo OAuth, requerido para credenciales
  image         String?   // Avatar URL
  
  // Relación con Role
  roleId        String?   // Opcional temporalmente para facilitar migración
  role          Role?     @relation(fields: [roleId], references: [id])
  
  // Relaciones Tickets
  ticketsAsignados  Ticket[] @relation("TicketAssignee")
  ticketsReportados Ticket[] @relation("TicketReporter")
  comentarios       TicketComment[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// El Activo Físico (Laptop, Monitor, Vehículo, etc.)
model Activo {
  id            String        @id @default(cuid())
  nombre        String
  descripcion   String?
  serial        String?       @unique // Crítico para inventario
  codigoInterno String        @unique // Placa de inventario de la empresa
  marca         String
  modelo        String?
  imagenUrl     String?
  estado        EstadoActivo  @default(DISPONIBLE)
  
  fechaCompra   DateTime
  precioCompra  Decimal       @db.Decimal(10, 2)
  vidaUtilMeses Int?          // Para depreciación

  // Relaciones
  asignaciones  Asignacion[]
  mantenimientos Mantenimiento[]
  tickets       Ticket[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

// Empleados o Departamentos que reciben los activos
model Persona {
  id            String       @id @default(cuid())
  nombre        String
  email         String       @unique
  departamento  String
  cargo         String?
  activo        Boolean      @default(true) // Si el empleado sigue en la empresa

  asignaciones  Asignacion[]
  ticketsSolicitados Ticket[]

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

// Historial de quién tuvo qué activo y cuándo
model Asignacion {
  id            String    @id @default(cuid())
  
  activoId      String
  activo        Activo    @relation(fields: [activoId], references: [id])
  
  personaId     String
  persona       Persona   @relation(fields: [personaId], references: [id])

  fechaAsignacion DateTime  @default(now())
  fechaDevolucion DateTime? // Null significa "actualmente asignado"
  observaciones   String?
  hojaAsignacionUrl String? // URL to the uploaded physical assignment sheet image

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Registro de reparaciones o revisiones
model Mantenimiento {
  id            String            @id @default(cuid())
  
  activoId      String
  activo        Activo            @relation(fields: [activoId], references: [id])

  tipo          TipoMantenimiento
  estado        EstadoMantenimiento @default(PROGRAMADO)
  descripcion   String
  costo         Decimal?          @db.Decimal(10, 2)
  fechaInicio   DateTime
  fechaFin      DateTime?
  realizadoPor  String?           // Proveedor o técnico interno
  comprobanteUrl String?          // URL o path al archivo adjunto (factura, informe, etc.)

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
}

// --- MÓDULO TICKETS ---

model Ticket {
  id            String         @id @default(cuid())
  titulo        String
  descripcion   String
  status        TicketStatus   @default(ABIERTO)
  prioridad     TicketPriority @default(MEDIA)
  
  // Relaciones con el sistema existente
  activoId      String?        // El dispositivo dañado (Opcional)
  activo        Activo?        @relation(fields: [activoId], references: [id])
  
  asignadoAId   String?        // Técnico asignado (User)
  asignadoA     User?          @relation("TicketAssignee", fields: [asignadoAId], references: [id])
  
  creadoPorId   String?        // Quien reportó (User/Admin)
  creadoPor     User?          @relation("TicketReporter", fields: [creadoPorId], references: [id])
  
  // Si reporta un empleado externo (Persona) en lugar de un usuario del sistema
  solicitanteId String?        
  solicitante   Persona?       @relation(fields: [solicitanteId], references: [id])

  comentarios   TicketComment[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model TicketComment {
  id        String   @id @default(cuid())
  contenido String
  interno   Boolean  @default(false) // Nota solo para técnicos
  
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
  
  autorId   String
  autor     User     @relation(fields: [autorId], references: [id])
  
  createdAt DateTime @default(now())
}
